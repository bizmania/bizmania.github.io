// ==UserScript==
// @name bm-userscript
// @version 7.0.0
// @namespace https://github.com/bizmania
// @description Visual improvements for bizmania.ru
// @author bizmania
// @homepage https://github.com/bizmania/bm-userscript#readme
// @updateURL https://bizmania.github.io/plugin/bm-userscript.meta.js
// @downloadURL https://bizmania.github.io/plugin/bm-userscript.user.js
// @license https://opensource.org/licenses/MIT
// @match https://bizmania.ru/*
// @require https://cdn.jsdelivr.net/npm/@trim21/gm-fetch@0.1.15
// @require https://cdn.jsdelivr.net/npm/axios@1.6.8
// @connect bizmania.github.io
// @connect bizmania.ru
// @grant GM.xmlHttpRequest
// ==/UserScript==

(()=>{"use strict";var __webpack_modules__={821:function(__unused_webpack_module,exports,__webpack_require__){var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:true});const vendorSelect_1=__webpack_require__(954);const weeklyPacks_1=__webpack_require__(565);(function(){return __awaiter(this,void 0,void 0,(function*(){var _a,_b,_c,_d,_e;const dlh=document.location.host;const dlp=document.location.pathname;const sp=new URLSearchParams(document.location.search);if(dlh!=="bizmania.ru"){return}if(dlp.startsWith("/user/messages")){return}const mainScript=(_b=(_a=document.querySelectorAll("#divmenu.menucontainer script")[1])===null||_a===void 0?void 0:_a.textContent)!==null&&_b!==void 0?_b:"";const myId=(_e=parseInt((_d=(_c=mainScript.match(/company\?id=(\d+)/))===null||_c===void 0?void 0:_c[1])!==null&&_d!==void 0?_d:"0"))!==null&&_e!==void 0?_e:0;console.log("bm-us",myId,document.location.href);switch(true){case dlp.startsWith("/user/gameshop"):{switch(sp.get("tab")){case"weeklypacks":{(0,weeklyPacks_1.onWeeklyPacksPage)();break}}break}case dlp.startsWith("/units/vendor/select"):{(0,vendorSelect_1.onVendorSelectPage)()}}}))})().catch(console.error)},954:function(__unused_webpack_module,exports,__webpack_require__){var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:true});exports.onVendorSelectPage=void 0;const vendorsTable_1=__webpack_require__(254);const onVendorSelectPage=()=>__awaiter(void 0,void 0,void 0,(function*(){(0,vendorsTable_1.upgradeVendorsTable)()}));exports.onVendorSelectPage=onVendorSelectPage},565:function(__unused_webpack_module,exports){var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:true});exports.onWeeklyPacksPage=void 0;const onWeeklyPacksPage=()=>__awaiter(void 0,void 0,void 0,(function*(){const qualificationEl=document.querySelectorAll("#content > div.tabbody > div > form > table > tbody > tr > td > div > table > tbody > tr:nth-child(3) > td > b");const priceEl=document.querySelectorAll("#content > div.tabbody > div > form > table > tbody > tr > td > div > table > tbody > tr:nth-child(4) > td > div > a > span");[...priceEl].forEach((function(i,ind){var _a,_b,_c,_d;const points=Number(qualificationEl[ind].textContent);const price=parseFloat((_b=(_a=i.textContent)===null||_a===void 0?void 0:_a.replace(/[^\d]/g,""))!==null&&_b!==void 0?_b:"0");const pointsPrice=Math.round(price*100/points)/100;const suffix=(_d=(_c=i.textContent)===null||_c===void 0?void 0:_c.replace(/\d/g,""))!==null&&_d!==void 0?_d:"";qualificationEl[ind].textContent+=` (${pointsPrice}${suffix})`}))}));exports.onWeeklyPacksPage=onWeeklyPacksPage},254:function(__unused_webpack_module,exports,__webpack_require__){var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:true});exports.upgradeVendorsTable=void 0;const formatNumber_1=__webpack_require__(897);const upgradeVendorsTable=()=>__awaiter(void 0,void 0,void 0,(function*(){const dd=document.querySelector("#vendorstbl");if(!dd){return}addFooterInfo(dd);const Price=dd.querySelector("tbody >tr > td:last-child").cellIndex+1;const mark="price";const Ck=0;if(mark==="price"){const priceCells=dd.querySelectorAll("tbody > tr > td:nth-child("+Price+")");priceCells.forEach((function(cell,row){const b=document.createElement("b");cell.appendChild(b);const c=calcK(dd,cell,row);if(Ck){b.style.color=c<=Ck?"green":"red"}b.textContent=" "+(0,formatNumber_1.formatNumber)(c.toFixed(c>100?0:2))}))}}));exports.upgradeVendorsTable=upgradeVendorsTable;const addFooterInfo=dd=>{var _a,_b,_c,_d;const dd2=dd.querySelector("tfoot > tr > td:nth-child(4)");if(!dd2){return}if(dd2.textContent==="Среднее по городу:"){const dd3=dd.querySelector("tfoot > tr > td:nth-child(8)")?dd.querySelector("tfoot > tr > td:nth-child(8)"):dd.querySelector("tfoot > tr > td:nth-child(6)");if(dd3){const C1=parseFloat((_b=(_a=dd3.textContent)===null||_a===void 0?void 0:_a.replace(/(p\.|\s)+/g,""))!==null&&_b!==void 0?_b:"");const C2=parseFloat((_d=(_c=dd.querySelector("tfoot > tr > td:nth-child(5)"))===null||_c===void 0?void 0:_c.textContent)!==null&&_d!==void 0?_d:"");const Ck=C1/C2;dd3.textContent+=" "+(0,formatNumber_1.formatNumber)(Ck.toFixed(Ck>100?0:2))}}};const calcK=(dd,i,row)=>{var _a,_b,_c;const cells=dd.querySelectorAll("tbody > tr > td:nth-child(9)");const cell=cells[row];const priceValue=parseFloat((_b=(_a=i.textContent)===null||_a===void 0?void 0:_a.replace(/(p\.|\s)+/g,""))!==null&&_b!==void 0?_b:"");return priceValue/parseFloat((_c=cell===null||cell===void 0?void 0:cell.textContent)!==null&&_c!==void 0?_c:"")}},897:(__unused_webpack_module,exports)=>{Object.defineProperty(exports,"__esModule",{value:true});exports.formatNumber=void 0;const moneyFormat=new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",signDisplay:"auto",minimumFractionDigits:0,maximumFractionDigits:2});const formatNumber=val=>{const value=parseFloat(val);return isNaN(value)?val:moneyFormat.format(value).replace(" "," ").replace(",",".").replace("₽","р.")};exports.formatNumber=formatNumber}};var __webpack_module_cache__={};function __webpack_require__(moduleId){var cachedModule=__webpack_module_cache__[moduleId];if(cachedModule!==undefined){return cachedModule.exports}var module=__webpack_module_cache__[moduleId]={exports:{}};__webpack_modules__[moduleId].call(module.exports,module,module.exports,__webpack_require__);return module.exports}var __webpack_exports__=__webpack_require__(821)})();